{% extends "global/base.html" %}

{% block main %}
<main class="layout">
    <!-- Sidebar Direito Fixo -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Em Alta</h2>
        </div>
        <p><strong>Bitcoin - 0.65%</strong></p>
        <p><strong>Ethereum - 1.82%</strong></p>
        <p><strong>Tether - 0.60%</strong></p>

        <h3>Tendência do Dia</h3>
        <p>Dogecoin está subindo 12% após tweet de Elon Musk.</p>
    </aside>

    <!-- Container da Escala (lado direito) -->
    <div class="escala-container">
        <div id="escala">
            <div class="escala-header">
                <h2><i class="bi bi-bar-chart-line-fill"></i> Mercados Globais</h2>
            </div>
            <!-- Widget TradingView -->
            <div class="tradingview-widget-container" style="margin-top:20px;">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript"
                    src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                    {
                        "colorTheme": "dark",
                        "dateRange": "12M",
                        "showChart": true,
                        "locale": "br",
                        "width": "100%",
                        "height": "400",
                        "largeChartUrl": "",
                        "isTransparent": false,
                        "showSymbolLogo": true,
                        "plotLineColorGrowing": "rgba(0, 212, 255, 1)",
                        "plotLineColorFalling": "rgba(255, 107, 107, 1)",
                        "gridLineColor": "rgba(42, 46, 57, 1)",
                        "scaleFontColor": "rgba(120, 123, 134, 1)",
                        "belowLineFillColorGrowing": "rgba(0, 212, 255, 0.12)",
                        "belowLineFillColorFalling": "rgba(255, 107, 107, 0.12)",
                        "symbolActiveColor": "rgba(0, 212, 255, 0.12)"
                    }
                </script>
            </div>
        </div>
    </div>

    <section id="Sobre" class="main">
        <div class="box container col-md-6 col-12">
            <h2 class="noticias">ÚLTIMAS NOTÍCIAS!</h2>
            <div class="video-container row">
                <div class="col-md-5 mb-3">
                    <iframe src="https://www.youtube.com/embed/njOHedn9yek" frameborder="0" allowfullscreen class="w-100"></iframe>
                </div>
                <div class="col-md-5 mb-3">
                    <iframe src="https://www.youtube.com/embed/fY6QBgnL3Y4" frameborder="0" allowfullscreen class="w-100"></iframe>
                </div>
                <div class="col-md-5 mb-3">
                    <iframe src="https://www.youtube.com/embed/wfVd-P-bvcU" frameborder="0" allowfullscreen class="w-100"></iframe>
                </div>
                <div class="col-md-5 mb-3">
                    <iframe src="https://www.youtube.com/embed/TD5vrphAyfg" frameborder="0" allowfullscreen class="w-100"></iframe>
                </div>
            </div>

            <div class="text-noticias">
                <h3 id="mais_noticias">Para mais noticias:</h3>
                <a href="{% url 'blog' %}" class="cliqueaqui">Clique aqui</a><br><br><br>
            </div>

            <div id="comentariosgeral">
                <h3 class="comenta">Comentários:</h3>
                {% if user.is_authenticated %}
                    <textarea id="comentarioInput" class="form-control" placeholder="Escreva um comentário..."></textarea><br>
                    <button onclick="adicionarComentario()" class="btn btn-primary">Comentar</button>
                {% else %}
                    <div class="alert alert-warning">
                        <a href="{% url 'login' %}" class="alert-link">Faça login</a> para comentar.
                    </div>
                {% endif %}
                <ul id="listaComentarios" class="list-unstyled mt-3">
                    {% for comentario in comentarios %}
                        <li class="comentario-item d-flex align-items-start mb-3">
                            <img src="{{ comentario.usuario.profile.photo.url }}" alt="Foto de perfil" class="rounded-circle" style="width: 40px; height: 40px; margin-right: 10px;">
                            <div class="comentario-conteudo">
                                <strong>{{ comentario.usuario.username }}</strong>
                                <time> - {{ comentario.data_postagem|date:"d/m/Y H:i" }}</time>
                                <p>{{ comentario.texto }}</p>
                            </div>
                        </li>
                </ul>
                        <script>
                            function adicionarComentario() {
                                const comentarioInput = document.getElementById('comentarioInput');
                                const textoComentario = comentarioInput.value.trim();
                            
                                if (textoComentario === '') {
                                    alert('Por favor, escreva um comentário.');
                                    return;
                                }
                            
                                fetch('/adicionar_comentario/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}'  // Inclua o token CSRF
                                    },
                                    body: JSON.stringify({ texto: textoComentario })
                                })
                                .then(response => {
                                    if (response.ok) {
                                        // Adicione o comentário à lista localmente
                                        const listaComentarios = document.getElementById('listaComentarios');
                                        const novoComentario = document.createElement('li');
                                        novoComentario.className = 'comentario-item d-flex align-items-start mb-3';
                                        const fotoPerfil = localStorage.getItem('profilePhoto') || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                                        novoComentario.innerHTML = `
                                            <img src="${fotoPerfil}" alt="Foto de perfil" class="rounded-circle" style="width: 40px; height: 40px; margin-right: 10px;">
                                            <div>
                                                <strong>${localStorage.getItem('profileName') || 'Usuário'}</strong> - agora:
                                                <p>${textoComentario}</p>
                                            </div>
                                        `;
                                        listaComentarios.appendChild(novoComentario);
                                        comentarioInput.value = '';
                                    } else {
                                        alert('Erro ao adicionar comentário.');
                                    }
                                })
                                .catch(error => {
                                    console.error('Erro:', error);
                                });
                            }
                            
                        </script>
                        
                    {% endfor %}
                </ul>
            </div>
            
    </section>
</main>
{% endblock main %}
